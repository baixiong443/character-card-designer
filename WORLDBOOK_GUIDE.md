# 🌍 Psyche 角色卡设计器 - 世界书功能指南

## 📋 功能概述

**世界书（Lorebook / World Book）** 是角色卡的动态知识注入系统，让 AI 能根据对话内容自动获取相关背景信息。

### 🎯 **为什么需要世界书？**

```
传统方式：把所有设定都写在角色描述里
问题：
  ❌ 占用大量 token
  ❌ AI 难以精准记住所有细节
  ❌ 不相关的信息会干扰对话

世界书方式：按关键词动态注入
优势：
  ✅ 只在需要时注入相关信息
  ✅ 节省 token，提高效率
  ✅ 支持复杂世界观，无限扩展
  ✅ SillyTavern 等平台完全兼容
```

---

## 🎨 **如何使用**

### **1. 进入世界整合阶段（阶段6）**

```
启动应用 → 点击"AI 工作流" → 依次完成前5个阶段 → 进入"阶段6：世界整合"
```

**在阶段6，你会看到两个部分**：
- **上方**：AI 对话区（讨论世界观）
- **下方**：世界书编辑器（创建条目）

---

### **2. 创建世界书条目**

#### **方法A：AI 自动生成** ⭐ 推荐

```
点击 [AI生成] 按钮
→ AI 自动分析你的角色设定
→ 生成 3-5 个世界书条目
→ 点击编辑按钮修改细节
```

**AI 会生成的条目类型**：
- 地点（如：羊村、狼堡）
- 人物（如：慢羊羊、红太狼）
- 物品（如：平底锅、发明）
- 事件（如：抓羊计划）
- 规则（如：游戏机制、魔法系统）

#### **方法B：手动添加**

```
点击 [添加条目] 按钮
→ 填写触发关键词
→ 填写条目内容
→ 点击保存
```

---

### **3. 编辑条目**

点击条目的 **编辑按钮** 后，你可以设置：

#### **基础设置**

| 字段 | 说明 | 示例 |
|------|------|------|
| **触发关键词** | 对话中出现这些词时注入 | `羊村, 青青草原, Sheep Village` |
| **条目内容** | 要注入的背景信息 | `羊村位于青青草原北岸...` |
| **备注** | 方便你自己查找（不会注入）| `主要地点` |

#### **高级选项**

| 选项 | 说明 | 用途 |
|------|------|------|
| **永久激活** | 始终注入，忽略关键词 | 核心设定（如：游戏规则） |
| **启用** | 是否启用这个条目 | 临时禁用某些条目测试效果 |

---

## 📤 **导出世界书**

### **导出为 JSON**

```
完成创作 → 点击"导出"按钮 → 选择"Character Card V3 JSON"
```

**导出的 JSON 包含**：
```json
{
  "spec": "chara_card_v3",
  "spec_version": "3.0",
  "data": {
    "name": "角色名",
    "description": "...",
    "character_book": {          // ← 世界书在这里
      "name": "角色's Lorebook",
      "entries": [
        {
          "id": 0,
          "keys": ["羊村", "青青草原"],
          "content": "羊村位于青青草原北岸...",
          "constant": false,
          "selective": true,
          ...
        }
      ]
    }
  }
}
```

### **导入到 SillyTavern**

```
1. 打开 SillyTavern
2. 点击 "Characters" → "Import"
3. 选择你导出的 JSON 文件
4. 世界书会自动加载！
```

**测试世界书是否生效**：
```
在 SillyTavern 对话中：
  你：我们去羊村玩吧
  AI：（此时"羊村"条目会自动注入，AI 知道羊村的详细信息）
```

---

## 📥 **导入现有角色卡的世界书**

### **导入 JSON 角色卡**

```
点击 "AI 工作流" → 右上角 [角色卡] 按钮
→ 选择现有的角色卡 JSON
→ 系统会自动提取世界书条目
→ 进入阶段6查看和编辑
```

**支持的格式**：
- ✅ Character Card V3 JSON (完整支持)
- ✅ Character Card V2 JSON (基础支持)
- ⚠️ PNG Card (需要先转换为 JSON)

---

## 🎓 **世界书最佳实践**

### **✅ 好的世界书条目**

#### **示例1：地点**
```
关键词：羊村, 青青草原, Sheep Village

内容：
羊村位于青青草原北岸，被坚固的铁栅栏保护。村内设有大肥羊学校、实验室、医务室等设施。慢羊羊是村长，带领小羊们过着和平的生活。村子经常遭到灰太狼的袭击，但每次都被聪明的喜羊羊化解。
```

**为什么好**：
- ✅ 包含多个触发词（中英文、别名）
- ✅ 信息密集但简洁（50-150字）
- ✅ 描述了关键设施、人物、事件

#### **示例2：人物**
```
关键词：灰太狼, Gray Wolf, 狼堡

内容：
灰太狼是住在青青河南岸狼堡的反派角色。他每天想尽办法抓羊，但总是被聪明的喜羊羊挫败。他有一个脾气暴躁的妻子红太狼，经常用平底锅敲他的头。灰太狼虽然屡战屡败，但从不放弃，口头禅是"我一定会回来的！"
```

**为什么好**：
- ✅ 关联了相关角色（红太狼）
- ✅ 包含标志性物品（平底锅）
- ✅ 包含性格特点和口头禅

#### **示例3：游戏机制** (RPG/跑团)
```
关键词：--战斗, --battle, 战斗系统

内容：(永久激活)
【战斗系统】
- 每回合行动顺序：敏捷决定
- 攻击判定：d20 + 攻击修正 vs AC
- 暴击：自然20，伤害翻倍
- 技能消耗：每个技能消耗对应的 MP
- 战斗结束：敌方HP归0或逃跑
```

**为什么好**：
- ✅ 设置为"永久激活"（游戏规则应始终存在）
- ✅ 使用指令关键词（如 `--战斗`）
- ✅ 清晰的规则列表

---

### **❌ 避免的问题**

#### **问题1：内容过长**
```
❌ 不好：
关键词：羊村

内容：
羊村是一个非常美丽的地方，位于青青草原的北岸，那里有很多很多的羊，包括喜羊羊、美羊羊、懒羊羊、沸羊羊、暖羊羊等等。村长是慢羊羊，他是一只非常聪明但是动作很慢的羊。羊村里有大肥羊学校，学校里有教室、操场、图书馆...（继续500字）

✅ 好：压缩到150字内，只保留关键信息
```

#### **问题2：关键词太泛**
```
❌ 不好：
关键词：他, 她, 的, 了  （太常见，会频繁误触发）

✅ 好：
关键词：喜羊羊, 喜喜, Pleasant Goat  （专有名词）
```

#### **问题3：重复信息**
```
❌ 不好：
条目1：羊村（包含慢羊羊的信息）
条目2：慢羊羊（完全重复羊村的内容）

✅ 好：
条目1：羊村（只提一句"慢羊羊是村长"）
条目2：慢羊羊（详细描述慢羊羊本人）
```

---

## 🔬 **高级功能**（基于 SillyTavern 源码）

我们的世界书系统完全兼容 SillyTavern 的所有高级功能：

### **已实现的字段**

```typescript
✅ keys               // 主关键词
✅ content            // 条目内容
✅ enabled            // 是否启用
✅ constant           // 永久激活
✅ selective          // 选择性触发
✅ insertion_order    // 注入顺序
✅ position           // 插入位置（before_char / after_char）
✅ secondary_keys     // 备用关键词
✅ scan_depth         // 扫描深度（向前查找多少条消息）
✅ probability        // 触发概率
✅ case_sensitive     // 区分大小写
✅ match_whole_words  // 全词匹配
✅ sticky             // 粘性（触发后保持N轮）
✅ cooldown           // 冷却（N轮内不再触发）
✅ delay              // 延迟（N轮后触发）
✅ group              // 分组
✅ prevent_recursion  // 防止递归触发
✅ extensions         // 扩展字段
```

### **未来可能添加**

```
- 正则表达式匹配
- 向量化搜索
- 自动化脚本
```

---

## 🧪 **测试你的世界书**

### **方法1：在 Psyche 设计器中预览**

```
创建完世界书 → 点击"导出" → 选择"Markdown"
→ 查看生成的文档，确认内容正确
```

### **方法2：在 SillyTavern 中测试**

```
1. 导出为 V3 JSON
2. 导入到 SillyTavern
3. 开始对话
4. 在右侧面板查看"World Info"激活状态
5. 故意提到关键词，观察 AI 是否获得了相关信息
```

**测试清单**：
- [ ] 关键词能正确触发
- [ ] 内容长度合适（不过长）
- [ ] 永久激活的条目始终存在
- [ ] 无关条目不会误触发
- [ ] 条目之间没有重复信息

---

## 📊 **示例：完整的世界书设计**

### **喜羊羊与灰太狼 - 世界书示例**

#### **条目1：羊村** (基础地点，永久激活)
```yaml
keys: [羊村, 青青草原, Sheep Village]
content: |
  羊村位于青青草原北岸，被铁栅栏保护。村内有大肥羊学校、实验室、医务室。
  慢羊羊是村长。村子经常遭灰太狼袭击，但总被喜羊羊化解。
constant: true
enabled: true
```

#### **条目2：狼堡** (对立地点)
```yaml
keys: [狼堡, 灰太狼的家, Wolf Castle]
content: |
  狼堡位于青青河南岸，是灰太狼和红太狼的住所。
  城堡破旧，经常因灰太狼抓羊失败而被红太狼用平底锅砸坏。
constant: false
enabled: true
```

#### **条目3：慢羊羊** (重要NPC)
```yaml
keys: [慢羊羊, 村长, Slow Goat]
content: |
  羊村村长，年迈睿智但动作缓慢。经营大肥羊学校。
  擅长发明，但发明常常出问题。走路、说话都很慢。
constant: false
enabled: true
```

#### **条目4：平底锅** (标志性物品)
```yaml
keys: [平底锅, 红太狼的平底锅, frying pan]
content: |
  红太狼的标志性武器。每当灰太狼抓羊失败，红太狼就会用平底锅敲他的头。
  "砰"的一声，灰太狼会被打飞。这是剧中的经典梗。
constant: false
enabled: true
```

#### **条目5：抓羊计划** (循环事件)
```yaml
keys: [抓羊, 灰太狼的计划, catch sheep]
content: |
  灰太狼的日常活动。他会设计各种机关陷阱抓羊，但总被喜羊羊识破。
  失败后他会喊"我一定会回来的！"然后被炸飞回狼堡。
constant: false
enabled: true
```

---

## 🎯 **小结**

```
✅ 世界书让 AI 更聪明 - 动态获取相关信息
✅ 创建简单 - AI 自动生成 + 手动编辑
✅ 导出标准 - 完全兼容 SillyTavern
✅ 导入方便 - 支持现有角色卡
✅ 扩展性强 - 支持复杂世界观
```

**现在就试试吧！** 🚀

---

## ❓ 常见问题

### Q: 世界书会占用多少 token？
```
A: 只有触发的条目才会注入，通常每个条目 50-150 token。
   相比把所有设定写在角色描述（可能1000+ token），世界书更高效。
```

### Q: 我能创建多少个条目？
```
A: 理论上无限，但建议：
   - 简单角色：3-5个条目
   - 复杂角色：10-20个条目
   - RPG游戏：20-50个条目（包含规则、地点、NPC）
```

### Q: 世界书会被 SillyTavern 识别吗？
```
A: 会！我们完全按照 SillyTavern 的源码实现，100%兼容。
   导入后，你会在 SillyTavern 的 "World Info" 面板看到所有条目。
```

### Q: 我可以在 SillyTavern 里编辑导入的世界书吗？
```
A: 可以！SillyTavern 支持完整的世界书编辑功能。
   你可以在那里继续完善，然后再导出回 Psyche 设计器。
```

### Q: PNG Card 支持吗？
```
A: 目前仅支持 JSON 格式。
   如果你有 PNG Card，请先在 SillyTavern 中导入，
   然后导出为 JSON 格式再使用。
```

---

**祝你创作愉快！** 🌟

如有问题，请查看 `README.md` 或项目文档。

